# ДЗ #8 Express.js + Mongoose

Приклад розробки сервера з використанням Express.js, що демонструє використання шаблонізаторів для представлення сторінок (PUG для користувацьких маршрутів та головної сторінки, EJS для маршрутів статей).
В поточній версії всі дані користувачів тепер зберігаються та керуються в базі даних MongoDB Atlas.

---

## 1. Технології

- **Node.js**
- **Express.js**
- **MongoDB Atlas**
- **Mongoose (ODM для MongoDB)**
- **PUG** (для рендерингу частин інтерфейсу)
- **EJS** (для рендерингу частин інтерфейсу)
- **Bootstrap** (для стилізації інтерфейсу)
- **`cookie-parser`**: для зручної роботи з HTTP cookies.
- **`express-session`**: для управління сесіями користувачів.
- **`passport`**: основна бібліотека для аутентифікації.
- **`passport-local`**: стратегія Passport для локальної аутентифікації (email/пароль).
- **`connect-flash`**: для зберігання тимчасових повідомлень у сесії.
- **`bcrypt`**: для безпечного хешування паролів.
- **`nodemailer`**: для відправки електронних листів (використовується для скидання пароля).
- **`crypto`**: для генерації криптографічно стійких токенів (для скидання пароля).
- **`dotenv`**: для управління змінними середовища.

---

## 2. Основа сервера

Попередні версії сервера доступні за посиланнями:

- [https://github.com/paniSil/hillel-express-2](https://github.com/paniSil/hillel-express-2)
- [https://github.com/paniSil/hillel-express-3](https://github.com/paniSil/hillel-express-3)
- [https://github.com/paniSil/hillel-express-4](https://github.com/paniSil/hillel-express-4)
- [https://github.com/paniSil/hillel-express-5](https://github.com/paniSil/hillel-express-5)
- [https://github.com/paniSil/mongo-express-1](https://github.com/paniSil/mongo-express-1)
- [https://github.com/paniSil/mongo-express-2](https://github.com/paniSil/mongo-express-2)
- [https://github.com/paniSil/mongo-express-3](https://github.com/paniSil/mongo-express-3)

В поточній версії використовується Mongoose для підвищення якості коду та введення схем даних. Всі взаємодії з базою даних і контролери оновлені з використання моделей Mongoose замість прямого використання MongoDB Driver. Додані схеми моделей, включаючи типи даних, валідацію та індексацію.

---

## 3. Використані Middleware

### 3.1. `logRequests` (`src/middleware/logRequests.mjs`)

Записує інформацію про кожен вхідний HTTP-запит (час, метод, URL) у консоль сервера. Допомагає у моніторингу та дебагінгу. Використовується глобально для всіх запитів (`app.use(logRequests)`).

### 3.2. `cookie-parser` (встановлюється в `server.mjs`)

Парсить HTTP-заголовки `Cookie` у об'єкт `req.cookies`, надаючи доступ до всіх кук. Використовується глобально (`app.use(cookieParser())`).

### 3.3. `express-session` (встановлюється в `server.mjs`)

Налаштовує систему сесій для Express.js. Відповідає за створення та управління сесіями користувачів на сервері та встановлення відповідної куки сесії на клієнті. Використовується глобально (`app.use(session({...}))`).

### 3.4. `connect-flash` (встановлюється в `server.mjs`)

Додає функціонал для зберігання та відображення тимчасових (flash) повідомлень у сесії, які видаляються після першого прочитання. Використовується для відображення повідомлень про помилки логіну чи реєстрації.

### 3.5. Ініціалізація Passport.js (`passport.initialize()`, `passport.session()`)

- `passport.initialize()`: Ініціалізує Passport.js.
- `passport.session()`: Додає middleware для інтеграції Passport.js з сесіями Express.js, дозволяючи Passport керувати станом аутентифікації користувача в сесії.

### 3.6. `Passport Local Strategy` (`src/middleware/passport.mjs`)

Конфігурує локальну стратегію Passport.js для аутентифікації за email та паролем. Всі операції з користувачами виконуються через Mongoose-моделі.

- Використовує `findUserByEmail` для пошуку користувача.
- Використовує `comparePasswords` (з `bcrypt`) для перевірки хешованого пароля.
- Визначає serializeUser (зберігає user.\_id з MongoDB в сесії, перетворюючи його на рядок) та deserializeUser (знаходить користувача за \_id з сесії в MongoDB та прикріплює його до req.user).

### 3.7. Authentication Middleware (`protect`) (`src/middleware/authHandler.mjs`)

Цей мідлвар відповідає за перевірку аутентифікації користувача за допомогою Passport.js.

- Використовує `req.isAuthenticated()` (метод, наданий Passport.js) для перевірки, чи користувач увійшов.
- Якщо користувач не автентифікований, перенаправляє його на сторінку логіну з flash-повідомленням.
- Застосовується до захищених маршрутів.

### 3.8. Authorization Middleware (`authorize`) (`src/middleware/authHandler.mjs`)

Цей мідлвар використовується для перевірки прав доступу користувача (авторизації) на основі його ролі.

- Працює після мідлвару `protect`, оскільки покладається на наявність `req.user` (об'єкт користувача, заповнений Passport.js).
- Приймає масив дозволених ролей.
- Якщо роль користувача (`req.user.role`) не відповідає дозволеним ролям, повертає 403 Forbidden.
- Застосовується до маршрутів, що вимагають специфічних прав доступу.

### 3.9. Валідатори (`validateUserBody`, `validateParamsUserId`, `validateArticleBody`, `validateParamsArticleId`, `validateUpdateManyArticlesBody`, `validateReplaceArticle`) (`src/validators/articleValidation.mjs`, `src/validators/userValidation.mjs`)

Виконують валідацію вхідних даних (тіла запиту або параметрів URL) за допомогою бібліотек **Joi** та **Celebrate**. Якщо дані не проходять валідацію, повертає 400 Bad Request з текстовим описом помилки.

### 3.10. Обробники помилок (`notFoundHandler`, `errorHandler`) (`src/middleware/errorHandler.mjs`)

- `notFoundHandler`: Обробляє запити до неіснуючих маршрутів, повертаючи 404 Not Found.
- `errorHandler`: Глобальний обробник помилок, який перехоплює всі необроблені помилки в додатку. Він спеціально обробляє помилки Celebrate, повертаючи 400 Bad Request з повідомленням про валідацію. Для інших помилок повертає 500 Internal Server Error.

Застосовуються глобально в `server.mjs`.

### 3.11. Інтеграція з MongoDB (server.mjs)

Сервер підключається до MongoDB Atlas за допомогою Mongoose.

- Запуск Express-сервера відбувається лише після успішного підключення до бази даних, щоб гарантувати її доступність.
- Конфігурація Passport.js (initPassport) ініціалізується після підключення до бази даних через Mongoose, що дозволяє Passport взаємодіяти з MongoDB для управління сесіями та автентифікацією користувачів.

### 3.12. Парсинг тіла запиту (express.json(), express.urlencoded())

- express.json(): для парсингу вхідних запитів з JSON, розміщує розпарсовані дані в req.body.
- express.urlencoded({ extended: true }): для парсингу вхідних запитів з URL-кодованим тілом, розміщує розпарсовані дані в req.body.
  Застосовуються глобально в `server.mjs`.

---

### 3.13. Допоміжні контролери

В контролерах є допоміжні функції findUserByEmail, findUserById, createUserInDb, updateUserInDb, findArticleByTitle для оптимізації роботи з користувачами і статтями. Всі ці функції працюють через Mongoose.

## 4. Реалізовані маршрути

Маршрути реалізовані за допомогою Express Router, з використанням Passport.js для аутентифікації та авторизації.

### 4.1. Кореневий маршрут (`/`)

- **`/` (GET)**: Базовий маршрут, що відображає головну сторінку.

### 4.2. Маршрути авторизації (`/auth`)

- **`/auth/register` (GET, POST)**:
  - `GET`: Відображає сторінку реєстрації.
  - `POST`: Реєструє нового користувача. Пароль хешується за допомогою bcrypt та зберігається в MongoDB Atlas. Потім користувач автоматично логіниться за допомогою req.login().
- **`/auth/login` (GET, POST)**:
  - `GET`: Відображає сторінку входу, може показувати flash-повідомлення про помилки.
  - `POST`: Аутентифікує користувача за допомогою passport.authenticate('local'), перевіряючи дані в MongoDB Atlas, встановлює сесію.
- **`/auth/logout` (POST)**: Завершує сесію користувача за допомогою `req.logout()` та перенаправляє на сторінку логіну.
- **`/auth/forgot` (GET, POST)**:
  - `GET`: Відображає форму для запиту скидання пароля за email.
  - `POST`: Обробляє запит. Генерує унікальний токен, який зберігається в об'єкті користувача в MongoDB Atlas. Відправляє посилання для скидання пароля на email (через Ethereal Email для тестування).
- **`/auth/reset/:token` (GET, POST)**:
  - `GET`: Відображає форму для введення нового пароля, якщо наданий токен дійсний та не прострочений (перевіряється в MongoDB Atlas).
  - `POST`: Обробляє запит, перевіряє токен, хешує новий пароль за допомогою bcrypt, оновлює пароль користувача в MongoDB Atlas та очищає токен скидання.

### 4.3. Маршрути управління темою (`/theme`)

- **`/theme` (GET, POST)**:
  - `GET`: Відображає сторінку налаштувань теми, показуючи поточну тему.
  - `POST`: Зберігає обрану користувачем тему в `httpOnly` cookie. Після збереження перенаправляє користувача назад на сторінку налаштувань теми, щоб оновити вигляд.

### 4.4. Користувачі (`/users`)

Ці маршрути тепер захищені Passport.js-аутентифікацією. Доступ дозволено лише автентифікованим користувачам. Всі операції читання, створення, оновлення та видалення користувачів тепер взаємодіють з колекцією users у MongoDB Atlas. При створенні та оновленні користувачів, до їхніх записів в MongoDB автоматично додаються поля createdAt та updatedAt для відстеження часу створення та останнього оновлення відповідно.

- **`/users` (GET)**: Отримати список усіх користувачів з MongoDB Atlas та відобразити їх на сторінці. Тепер перебір користувачів здійснюється через Mongoose (find().lean())
- **`/users` (POST)**: Додати нового користувача до MongoDB Atlas.
- **`/users/:id` (GET)**: Отримати інформацію про користувача за ID з MongoDB Atlas.
- **`/users/:id` (PUT)**: Оновити дані користувача за ID у MongoDB Atlas.
- **`/users/:id` (DELETE)**: Видалити користувача за ID з MongoDB Atlas.

### 4.5. Статті (`/articles`)

Ці маршрути тепер **захищені** Passport.js-аутентифікацією та **авторизацією за ролями** (`authorize('admin')`). Доступ дозволено лише автентифікованим користувачам з відповідною роллю (наприклад, 'admin'). Всі операції читання, створення, оновлення та видалення статей тепер взаємодіють з колекцією users у MongoDB Atlas. При створенні та оновленні статтей, до її записів в MongoDB автоматично додаються поля createdAt та updatedAt для відстеження часу створення та останнього оновлення відповідно.

#### Створення даних

- **insertOne**: POST /articles — створення однієї статті (тіло: { title, text }). При створенні нової статті (/articles/new) за допомогою createNewArticleHandler реалізована перевірка на унікальність заголовка (повертається 409 та відображається помилка в EJS). postArticleHandler також виконує перевірку, повертає JSON.
- **insertMany**: POST /articles/many — створення багатьох статей (масив об'єктів)

#### Оновлення даних

- **updateOne**: PUT /articles/:id — оновлення однієї статті за ID (тіло: { title?, text? })
- **updateMany**: PUT /articles/many — оновлення багатьох статей за фільтром (тіло: { filter, update })
- **replaceOne**: PUT /articles/replace — повна заміна статті за фільтром (тіло: { query, replacement })

#### Видалення даних

- **deleteOne**: DELETE /articles/:id — видалення однієї статті за ID
- **deleteMany**: DELETE /articles/many — видалення багатьох статей за фільтром (тіло: фільтр)

#### Розширене читання

- **`/articles` (GET)**: Отримати всі статті. Підтримує:
- фільтрацію за будь-яким полем (наприклад, ?title=Test)
- проекцію (тільки потрібні поля): ?projection={"title":1,"createdAt":1}
- сортування: ?sort={"createdAt":-1}
- ліміти та пропуски: ?limit=5&skip=10
- Для перебору статей у getArticlesHandler використовується курсор Mongoose (Article.find().cursor()), що дозволяє ефективно обробляти великі обсяги даних без завантаження всіх документів у пам’ять.
- режим API (JSON при відсутності Accept: text/html)

#### Статистика статей

- GET `/articles/stats`: Отримання агрегованої статистики статей (як API endpoint, повертає JSON). Статистика за роком створення.
- GET `/articles/stats/view`: Відображення сторінки зі статистикою статей (як WEB VIEW, рендерить Pug). Статистика за роком створення.

### 4.6. Управління cookies (Демонстраційні маршрути)

- **`/set-cookie` (GET)**: Встановлює демонстраційну куку `user`.
- **`/get-cookie` (GET)**: Отримує та відображає значення демонстраційної куки `user`.
  _Примітка: Ці маршрути є лише для демонстрації роботи `cookie-parser` і не є частиною основної функціональності аутентифікації._

---

## 5. Використані шаблонізатори

У цьому проєкті демонструється можливість комбінованого використання різних шаблонних рушіїв в одному Express.js застосунку.

### 5.1. PUG для сторінок користувачів та індексу

**PUG** використовується для рендерингу сторінок, що стосуються управління користувачами:

- сторінка списку усіх користувачів (`/users`)
- сторінка з інформацією про кожного окремого користувача (`/users/:id`).
  А також для рендеру головної сторінки (`/`) та інтерфейсів аутентифікації (`/auth/login`, `/auth/register`, `/auth/forgot`, `/auth/reset`).
- сторінки входу, реєстрації та відновлення пароля. Форма реєстрації потребує ім'я, email, пароль та вік користувача (необов'язково).

Також використовується для рендерингу сторінки статистики статей:

- cторінка статистики статей з агрегацією за роком створення (`/articles/stats/view`)

### 5.2. EJS для сторінок статей

**EJS** застосовується для візуалізації сторінок, пов'язаних зі статтями:

- сторінка списку всіх статей (`/articles`).
- сторінка окремої статті (`/articles/:id`).
- сторінка для додавання нової статті (`/articles/new`)

---

## 6. Статичні файли

Сервер налаштований на обслуговування статичних файлів з папки `public` за допомогою `express.static('public')`. Це дозволяє легко підключати CSS-файли (`/styles.css`), зображення та іконки.

### 6.1. Favicon

Файл `favicon.png` знаходиться в папці `public` і підключений до всіх шаблонізаторів для відображення фавікону на кожній сторінці.

---

## 7. Робота з Cookies

Реалізовано функціональність збереження налаштувань користувача, зокрема обраної теми оформлення сайту, за допомогою HTTP cookies.

- `cookie-parser`: Використовується для парсингу та маніпуляції всіма куками.
- **Збереження теми**: Обрана тема зберігається в cookie з назвою `theme`.
- **Доступні** `light` і `dark` теми.
- **Сесійна кука**: `express-session` автоматично встановлює свою куку для ідентифікації сесії. Вона налаштована з `httpOnly: true` та `secure: true` (у продакшені) для безпеки.

---

## 8. Інтеграція Passport.js

Система аутентифікації побудована на **Passport.js** для безпечної та гнучкої авторизації на основі сесій. Тепер Passport.js повністю інтегрований з MongoDB Atlas для управління користувачами.

- **Локальна стратегія**: Використовується для аутентифікації за email та паролем, перевіряючи дані в MongoDB Atlas.
- **Серіалізація/Десеріалізація**: Passport зберігає лише \_id користувача (отриманий з MongoDB) в сесії (serializeUser), а потім відновлює повний об'єкт користувача за цим \_id з MongoDB Atlas (deserializeUser) та прикріплює його до req.user.
- **Реєстрація**: Користувачі можуть зареєструватися, їхні паролі хешуються за допомогою bcrypt перед збереженням у MongoDB Atlas. Нові користувачі за замовчуванням отримують роль 'admin' (це тимчасове рішення для демонстрації авторизації за ролями).
- **Вхід**: Після успішного входу Passport встановлює сесію, і користувач вважається автентифікованим.
- **Захист маршрутів**: Спеціальний мідлвар (`protect`) перевіряє стан автентифікації (`req.isAuthenticated()`) для доступу до захищених ресурсів.
- **Авторизація за ролями**: Додатковий мідлвар (authorize) дозволяє обмежувати доступ до певних маршрутів лише для користувачів з визначеними ролями, які зберігаються в об'єкті req.user (отриманому з MongoDB Atlas).
- **Відновлення пароля**: Реалізовано повний потік скидання пароля через email з використанням тимчасових токенів, які зберігаються та перевіряються в MongoDB Atlas.

---

## 9. Тестування Vitest

Для тестування попередніх версій сервера використовувався Vitest. В поточній версії тести не використовуються.

---

## 10. Налаштування репозиторію і запуск сервера:

### 10.0

Створіть файл .env у корені проекту та додайте наступні змінні:
`MONGO_URI="mongodb+srv://<username>:<password>@<your-cluster-url>/expressServerTestBase?retryWrites=true&w=majority"`
`SESSION_SECRET="secretsession"`

Важливо: Замініть <username>, <password> та <your-cluster-url> на ваші реальні дані з MongoDB Atlas. Файл відсутній в репозиторії з міркувань безпеки.

### 10.1. Завантажуємо репозиторій та розгортаємо проект

`npm install`

або

`yarn`

_yarn повинен бути встановлений глобально, це можна зробити командой:_

`npm i -g yarn`

### 10.2. Запускаємо сервер

`npm start

# або

node src/server.mjs`

### 10.3. Перевіряємо роботу сервера

Сервер буде запущено на порту 3000. Ви побачите повідомлення у консолі: Сервер запущений за адресою http://localhost:3000.

### 10.4. Припинення роботи сервера

Необхідно повернутися до терміналу і натиснути комбінацію клавіш Ctrl + C

---
